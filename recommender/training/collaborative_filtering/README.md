Tried parallelizing the code but it is still too slow
